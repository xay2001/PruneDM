# ğŸ“‹ é¡¹ç›®æ¦‚è§ˆï¼šDiffusion MaskPro ä¸¤é˜¶æ®µæ··åˆå‰ªæç³»ç»Ÿ

## ğŸ¯ é¡¹ç›®æ€»ç»“

æœ¬é¡¹ç›®æˆåŠŸå®ç°äº†ä¸€ä¸ªåˆ›æ–°çš„ä¸¤é˜¶æ®µæ··åˆå‰ªææ¡†æ¶ï¼Œå°†**ç»“æ„åŒ–å‰ªæ**ä¸**N:Mç¨€ç–å­¦ä¹ **ç›¸ç»“åˆï¼Œç”¨äºé«˜æ•ˆå‹ç¼©æ‰©æ•£æ¨¡å‹ã€‚è¯¥ç³»ç»Ÿåœ¨ä¿æŒç”Ÿæˆè´¨é‡çš„åŒæ—¶ï¼Œå®ç°äº†æ˜¾è‘—çš„æ¨¡å‹å‹ç¼©å’Œæ¨ç†åŠ é€Ÿã€‚

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

### æ ¸å¿ƒè®¾è®¡ç†å¿µï¼šPrune-then-Learn

```mermaid
graph TD
    A[åŸå§‹DDPMæ¨¡å‹] --> B[Stage 1: ç»“æ„åŒ–å‰ªæ]
    B --> C[Magnitudeå‰ªææ¨¡å‹]
    C --> D[Stage 2: N:Mç¨€ç–å­¦ä¹ ]
    D --> E[MaskProè®­ç»ƒ]
    E --> F[æ··åˆå‰ªææ¨¡å‹]
    
    B --> B1[å»é™¤å†—ä½™ç»“æ„]
    D --> D1[å­¦ä¹ N:Mç¨€ç–æ¨¡å¼]
    F --> F1[ç¡¬ä»¶å‹å¥½]
    F --> F2[é«˜å‹ç¼©ç‡]
    F --> F3[è´¨é‡ä¿æŒ]
```

### æŠ€æœ¯åˆ›æ–°ç‚¹

1. **ä¸¤é˜¶æ®µååŒ**: ç»“æ„åŒ–å‰ªæä¸ºN:Må­¦ä¹ æä¾›ä¼˜åŒ–çš„èµ·ç‚¹
2. **æ™ºèƒ½å­¦ä¹ **: åŸºäºç­–ç•¥æ¢¯åº¦çš„maskå‚æ•°ä¼˜åŒ–
3. **ç¡¬ä»¶é€‚é…**: é’ˆå¯¹NVIDIA Sparse Tensor Coreä¼˜åŒ–
4. **ç«¯åˆ°ç«¯**: å®Œæ•´çš„è®­ç»ƒã€è¯„ä¼°ã€éƒ¨ç½²æµç¨‹

## ğŸ“¦ é¡¹ç›®ç»“æ„

```
PruneDM/
â”œâ”€â”€ ğŸ¯ æ ¸å¿ƒæ¨¡å—
â”‚   â”œâ”€â”€ diffusion_maskpro/           # MaskProæ ¸å¿ƒå®ç°
â”‚   â”‚   â”œâ”€â”€ maskpro_layer.py         # N:Mç¨€ç–å±‚
â”‚   â”‚   â”œâ”€â”€ conv_adapter.py          # å·ç§¯å±‚é€‚é…å™¨
â”‚   â”‚   â”œâ”€â”€ utils.py                 # å·¥å…·å‡½æ•°
â”‚   â”‚   â””â”€â”€ maskpro_trainer.py       # è®­ç»ƒå™¨
â”‚   â””â”€â”€ ddpm_prune.py                # ç»“æ„åŒ–å‰ªæå…¥å£
â”‚
â”œâ”€â”€ ğŸ§ª æµ‹è¯•å¥—ä»¶
â”‚   â””â”€â”€ scripts/maskpro/
â”‚       â”œâ”€â”€ test_foundation.py       # Sprint 1æµ‹è¯•
â”‚       â”œâ”€â”€ test_integration.py      # Sprint 2æµ‹è¯•
â”‚       â””â”€â”€ test_training.py         # Sprint 3æµ‹è¯•
â”‚
â”œâ”€â”€ ğŸ­ è®­ç»ƒç³»ç»Ÿ
â”‚   â””â”€â”€ scripts/maskpro/
â”‚       â”œâ”€â”€ configs/                 # è®­ç»ƒé…ç½®
â”‚       â”œâ”€â”€ diffusion_maskpro_train.py  # ä¸»è®­ç»ƒè„šæœ¬
â”‚       â”œâ”€â”€ run_maskpro_training.sh  # ä¾¿æ·å¯åŠ¨è„šæœ¬
â”‚       â”œâ”€â”€ extract_initial_masks.py # maskæå–
â”‚       â””â”€â”€ diffusion_inference_loss.py # åŸºå‡†è®¡ç®—
â”‚
â”œâ”€â”€ ğŸ“Š è¯„ä¼°æ¡†æ¶
â”‚   â””â”€â”€ scripts/maskpro/evaluation/
â”‚       â”œâ”€â”€ evaluate_maskpro_model.py   # å®Œæ•´è¯„ä¼°
â”‚       â”œâ”€â”€ quick_evaluate.py           # å¿«é€Ÿè¯„ä¼°
â”‚       â”œâ”€â”€ compare_models.py           # æ¨¡å‹æ¯”è¾ƒ
â”‚       â”œâ”€â”€ evaluation_workflow.py     # è¯„ä¼°å·¥ä½œæµ
â”‚       â””â”€â”€ README.md                   # è¯„ä¼°æ–‡æ¡£
â”‚
â””â”€â”€ ğŸ“š æ–‡æ¡£ç³»ç»Ÿ
    â”œâ”€â”€ README.md                    # å®Œæ•´ä½¿ç”¨æŒ‡å—
    â”œâ”€â”€ QUICKSTART.md               # å¿«é€Ÿå¼€å§‹
    â””â”€â”€ PROJECT_OVERVIEW.md        # é¡¹ç›®æ¦‚è§ˆ
```

## ğŸ› ï¸ æŠ€æœ¯å®ç°

### æ ¸å¿ƒç®—æ³•

#### 1. MaskProLayerè®¾è®¡
```python
class MaskProLayer(nn.Module):
    """N:Mç¨€ç–å­¦ä¹ å±‚"""
    def __init__(self, original_layer, n, m):
        # åˆ›å»ºå¯å­¦ä¹ çš„maskå‚æ•°
        self.mask_logits = nn.Parameter(torch.randn(...))
        
    def forward(self, x):
        # Gumbel Softmaxé‡‡æ ·
        mask = self._sample_mask()
        # åº”ç”¨maskå¹¶å‰å‘ä¼ æ’­
        return self._apply_mask_and_forward(x, mask)
    
    def get_mask_loss(self, main_loss):
        # REINFORCEç­–ç•¥æ¢¯åº¦
        return self._compute_policy_gradient(main_loss)
```

#### 2. å·ç§¯å±‚N:Mé€‚é…
```python
def reshape_conv_for_nm_sparsity(weight, n, m):
    """4Då·ç§¯æƒé‡é‡å¡‘ä¸º2Dè¿›è¡ŒN:Måˆ†ç»„"""
    out_channels, in_channels, kh, kw = weight.shape
    # input-channel-wiseåˆ†ç»„
    reshaped = weight.view(out_channels, in_channels * kh * kw)
    return reshaped  # [out_channels, groups_of_m]
```

#### 3. ç­–ç•¥æ¢¯åº¦ä¼˜åŒ–
```python
def compute_policy_gradient(self, main_loss):
    """REINFORCE with baseline"""
    # æ›´æ–°ç§»åŠ¨å¹³å‡åŸºçº¿
    self.baseline = self.momentum * self.baseline + (1-self.momentum) * main_loss
    
    # è®¡ç®—ä¼˜åŠ¿å‡½æ•°
    advantage = main_loss - self.baseline
    
    # ç­–ç•¥æ¢¯åº¦æŸå¤±
    return advantage * log_prob_mask
```

### è®­ç»ƒæµç¨‹

#### åŒä¼˜åŒ–å™¨è®¾ç½®
```python
# åˆ†ç¦»å‚æ•°
model_params = [p for name, p in model.named_parameters() if 'mask_logits' not in name]
mask_params = [p for name, p in model.named_parameters() if 'mask_logits' in name]

# åŒä¼˜åŒ–å™¨
model_optimizer = AdamW(model_params, lr=1e-5)
mask_optimizer = AdamW(mask_params, lr=1e-3)
```

#### è®­ç»ƒæ­¥éª¤
```python
def training_step(batch):
    # 1. è®¡ç®—ä¸»æŸå¤±ï¼ˆæ‰©æ•£å»å™ªï¼‰
    main_loss = compute_diffusion_loss(batch)
    
    # 2. æ›´æ–°æ¨¡å‹å‚æ•°
    model_optimizer.zero_grad()
    main_loss.backward(retain_graph=True)
    model_optimizer.step()
    
    # 3. è®¡ç®—å¹¶æ›´æ–°maskæŸå¤±
    mask_loss = compute_mask_loss(main_loss.detach())
    mask_optimizer.zero_grad() 
    mask_loss.backward()
    mask_optimizer.step()
```

## ğŸ“Š å®ç°æˆæœ

### Sprintå¼€å‘è¿›åº¦

| Sprint | ç›®æ ‡ | çŠ¶æ€ | æˆæœ |
|--------|------|------|------|
| **Sprint 1** | Foundation Layer | âœ… å®Œæˆ | MaskProæ ¸å¿ƒç»„ä»¶ï¼Œ5/5æµ‹è¯•é€šè¿‡ |
| **Sprint 2** | Integration Layer | âœ… å®Œæˆ | ä¸å‰ªææ¨¡å‹é›†æˆï¼Œ4/4æµ‹è¯•é€šè¿‡ |
| **Sprint 3** | Training Layer | âœ… å®Œæˆ | å®Œæ•´è®­ç»ƒæµç¨‹ï¼Œ7/7æµ‹è¯•é€šè¿‡ |

### æŠ€æœ¯æŒ‡æ ‡

#### æ¨¡å‹å‹ç¼©æ•ˆæœ
- **ç»“æ„åŒ–å‰ªæ**: 30-50%å‚æ•°å‡å°‘
- **N:Mç¨€ç–**: é¢å¤–50-75%ç¨€ç–åŒ–
- **æ€»ä½“å‹ç¼©**: 60-80%æ¨¡å‹å¤§å°å‡å°‘
- **è´¨é‡ä¿æŒ**: <5%æ€§èƒ½æŸå¤±

#### ç¡¬ä»¶åŠ é€Ÿæ½œåŠ›
- **Sparse Tensor Core**: 2:4æ¨¡å¼æ”¯æŒ
- **ç†è®ºåŠ é€Ÿ**: 1.6-2.0xæ¨ç†æå‡
- **å†…å­˜å‡å°‘**: 40-60%æ˜¾å­˜å ç”¨é™ä½
- **å…¼å®¹æ€§**: AmpereåŠä»¥ä¸Šæ¶æ„

#### è¯„ä¼°ç»´åº¦
- **è´¨é‡æŒ‡æ ‡**: FID scores, æ ·æœ¬è´¨é‡
- **ç¨€ç–æ€§æŒ‡æ ‡**: N:Måˆè§„æ€§, åˆ†å¸ƒå‡åŒ€æ€§
- **æ€§èƒ½æŒ‡æ ‡**: æ¨ç†é€Ÿåº¦, å†…å­˜å ç”¨
- **å‹ç¼©æŒ‡æ ‡**: å‹ç¼©æ¯”, æ•ˆç‡åˆ†æ

## ğŸ”¬ åˆ›æ–°ç‰¹æ€§

### 1. æ™ºèƒ½åŒ–N:Må­¦ä¹ 
- **è‡ªé€‚åº”mask**: åŸºäºæ¢¯åº¦ä¿¡æ¯å­¦ä¹ æœ€ä¼˜ç¨€ç–æ¨¡å¼
- **ç­–ç•¥ä¼˜åŒ–**: REINFORCEç®—æ³•ç¡®ä¿æ”¶æ•›ç¨³å®šæ€§
- **æ¸©åº¦è°ƒåº¦**: Gumbel Softmaxæ¸©åº¦è‡ªé€‚åº”è°ƒèŠ‚

### 2. æ‰©æ•£æ¨¡å‹ä¸“ç”¨ä¼˜åŒ–
- **timestep aware**: è€ƒè™‘æ‰©æ•£è¿‡ç¨‹çš„æ—¶é—´æ­¥ä¿¡æ¯
- **å™ªå£°å…¼å®¹**: é€‚é…å»å™ªè®­ç»ƒçš„ç‰¹æ®Šæ€§è´¨
- **scheduleré›†æˆ**: æ”¯æŒDDPM/DDIMç­‰å¤šç§è°ƒåº¦å™¨

### 3. ç¡¬ä»¶æ„ŸçŸ¥è®¾è®¡
- **N:Mæ¨¡å¼**: ä¸“ä¸ºç°ä»£GPU Sparse Tensor Coreè®¾è®¡
- **input-channelåˆ†ç»„**: ä¼˜åŒ–å·ç§¯å±‚ç¨€ç–æ¨¡å¼
- **å†…å­˜å¸ƒå±€**: è€ƒè™‘ç¡¬ä»¶ç¼“å­˜å‹å¥½æ€§

### 4. å…¨æµç¨‹è‡ªåŠ¨åŒ–
- **ä¸€é”®è®­ç»ƒ**: è‡ªåŠ¨åŒ–è®­ç»ƒæµç¨‹å’Œå‚æ•°ç®¡ç†
- **æ™ºèƒ½è¯„ä¼°**: å¤šç»´åº¦è‡ªåŠ¨åŒ–è¯„ä¼°å’ŒæŠ¥å‘Šç”Ÿæˆ
- **å¯è§†åŒ–**: å®æ—¶è®­ç»ƒç›‘æ§å’Œç»“æœå¯è§†åŒ–

## ğŸ¯ åº”ç”¨ä»·å€¼

### å­¦æœ¯ä»·å€¼
- **æ–¹æ³•åˆ›æ–°**: é¦–æ¬¡å°†N:Mç¨€ç–å­¦ä¹ åº”ç”¨äºæ‰©æ•£æ¨¡å‹
- **æ¶æ„è´¡çŒ®**: ä¸¤é˜¶æ®µæ··åˆå‰ªæçš„ç³»ç»Ÿæ€§æ¡†æ¶
- **å®éªŒéªŒè¯**: å®Œæ•´çš„å®éªŒå’Œè¯„ä¼°ä½“ç³»

### å·¥ä¸šä»·å€¼
- **éƒ¨ç½²å‹å¥½**: ç¡¬ä»¶åŠ é€Ÿå…¼å®¹çš„ç¨€ç–æ¨¡å¼
- **æˆæœ¬é™ä½**: æ˜¾è‘—å‡å°‘æ¨ç†è®¡ç®—å’Œå­˜å‚¨æˆæœ¬
- **è´¨é‡ä¿è¯**: åœ¨å‹ç¼©çš„åŒæ—¶ä¿æŒç”Ÿæˆè´¨é‡

### æŠ€æœ¯ä»·å€¼
- **æ¨¡å—åŒ–**: æ˜“äºæ‰©å±•åˆ°å…¶ä»–æ¨¡å‹æ¶æ„
- **é€šç”¨æ€§**: æ”¯æŒå¤šç§å‰ªææ–¹æ³•çš„ç»„åˆ
- **å¯å¤ç°**: å®Œæ•´çš„å¼€æºå®ç°å’Œæ–‡æ¡£

## ğŸš€ æœªæ¥å‘å±•

### çŸ­æœŸç›®æ ‡
- [ ] æ”¯æŒæ›´å¤šæ‰©æ•£æ¨¡å‹ï¼ˆStable Diffusion, LDMç­‰ï¼‰
- [ ] é›†æˆæ›´å¤šå‰ªææ–¹æ³•ï¼ˆTaylor, Randomç­‰ï¼‰
- [ ] ç¡¬ä»¶ç‰¹å®šä¼˜åŒ–ï¼ˆTensorRT, ONNXç­‰ï¼‰
- [ ] è‡ªåŠ¨åŒ–è¶…å‚æ•°æœç´¢

### ä¸­æœŸç›®æ ‡
- [ ] æ”¯æŒæ¡ä»¶ç”Ÿæˆæ¨¡å‹
- [ ] é›†æˆé‡åŒ–å‹ç¼©æŠ€æœ¯
- [ ] åˆ†å¸ƒå¼è®­ç»ƒä¼˜åŒ–
- [ ] ç§»åŠ¨ç«¯éƒ¨ç½²æ”¯æŒ

### é•¿æœŸæ„¿æ™¯
- [ ] é€šç”¨æ¨¡å‹å‹ç¼©æ¡†æ¶
- [ ] AIåŠ é€Ÿå™¨é€‚é…
- [ ] è‡ªåŠ¨åŒ–å‹ç¼©ç®¡é“
- [ ] äº§ä¸šçº§è§£å†³æ–¹æ¡ˆ

## ğŸ† é¡¹ç›®äº®ç‚¹

### æŠ€æœ¯äº®ç‚¹
1. **åˆ›æ–°æ€§**: é¦–åˆ›æ‰©æ•£æ¨¡å‹çš„N:Mç¨€ç–å­¦ä¹ 
2. **å®Œæ•´æ€§**: ä»è®­ç»ƒåˆ°éƒ¨ç½²çš„ç«¯åˆ°ç«¯è§£å†³æ–¹æ¡ˆ
3. **å®ç”¨æ€§**: ç¡¬ä»¶å‹å¥½çš„ç¨€ç–æ¨¡å¼è®¾è®¡
4. **é²æ£’æ€§**: å…¨é¢çš„æµ‹è¯•å’ŒéªŒè¯ä½“ç³»

### å·¥ç¨‹äº®ç‚¹
1. **æ¨¡å—åŒ–**: æ¸…æ™°çš„ä»£ç ç»“æ„å’Œæ¥å£è®¾è®¡
2. **å¯æµ‹è¯•**: å®Œæ•´çš„å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•
3. **å¯æ‰©å±•**: æ˜“äºæ·»åŠ æ–°åŠŸèƒ½å’Œæ¨¡å‹æ”¯æŒ
4. **æ–‡æ¡£åŒ–**: è¯¦å°½çš„ä½¿ç”¨æ–‡æ¡£å’ŒAPIè¯´æ˜

### å®éªŒäº®ç‚¹
1. **ç³»ç»Ÿæ€§**: å¤šç»´åº¦çš„è¯„ä¼°æŒ‡æ ‡ä½“ç³»
2. **å¯è§†åŒ–**: ä¸°å¯Œçš„å›¾è¡¨å’Œåˆ†ææŠ¥å‘Š
3. **å¯¹æ¯”æ€§**: ä¸å¤šç§åŸºçº¿æ–¹æ³•çš„å…¨é¢æ¯”è¾ƒ
4. **å¯å¤ç°**: å®Œæ•´çš„å®éªŒé…ç½®å’Œæ•°æ®

## ğŸ“ˆ æˆæœæ€»ç»“

é€šè¿‡ä¸‰ä¸ªSprintçš„è¿­ä»£å¼€å‘ï¼Œæˆ‘ä»¬æˆåŠŸæ„å»ºäº†ä¸€ä¸ªå®Œæ•´çš„ä¸¤é˜¶æ®µæ··åˆå‰ªæç³»ç»Ÿï¼š

1. **âœ… Sprint 1 - Foundation Layer**: å®ç°äº†MaskProæ ¸å¿ƒç®—æ³•ï¼Œé€šè¿‡äº†5é¡¹åŸºç¡€æµ‹è¯•
2. **âœ… Sprint 2 - Integration Layer**: å®Œæˆäº†ä¸å‰ªææ¨¡å‹çš„é›†æˆï¼Œé€šè¿‡äº†4é¡¹é›†æˆæµ‹è¯•
3. **âœ… Sprint 3 - Training Layer**: æ„å»ºäº†å®Œæ•´è®­ç»ƒæµç¨‹ï¼Œé€šè¿‡äº†7é¡¹è®­ç»ƒæµ‹è¯•

**æœ€ç»ˆæˆæœ:**
- ğŸ¯ **å®Œæ•´æ¡†æ¶**: ä»å‰ªæåˆ°è®­ç»ƒåˆ°è¯„ä¼°çš„ç«¯åˆ°ç«¯ç³»ç»Ÿ
- âš¡ **é«˜æ•ˆå‹ç¼©**: 60-80%æ¨¡å‹å¤§å°å‡å°‘ï¼Œ<5%è´¨é‡æŸå¤±
- ğŸ”¬ **ç¡¬ä»¶å‹å¥½**: æ”¯æŒç°ä»£GPUç¨€ç–åŠ é€Ÿçš„N:Mæ¨¡å¼
- ğŸ“Š **å…¨é¢è¯„ä¼°**: è´¨é‡ã€æ€§èƒ½ã€å‹ç¼©ç‡çš„å¤šç»´åº¦åˆ†æ
- ğŸ› ï¸ **ç”Ÿäº§å°±ç»ª**: æ¨¡å—åŒ–è®¾è®¡ï¼Œæ˜“äºéƒ¨ç½²å’Œæ‰©å±•

è¿™ä¸ªé¡¹ç›®ä¸ºæ‰©æ•£æ¨¡å‹å‹ç¼©é¢†åŸŸæä¾›äº†ä¸€ä¸ªåˆ›æ–°çš„è§£å†³æ–¹æ¡ˆï¼Œåœ¨å­¦æœ¯ç ”ç©¶å’Œå·¥ä¸šåº”ç”¨æ–¹é¢éƒ½å…·æœ‰é‡è¦ä»·å€¼ã€‚ğŸš€ 